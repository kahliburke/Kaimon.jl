#!/usr/bin/env -S julia -t auto
#
# Kaimon TUI launcher
#
# Usage:
#   ./bin/kaimon              # default port 2828, kokaku theme
#   ./bin/kaimon --port 3000  # custom port
#   ./bin/kaimon --theme esper
#   ./bin/kaimon --revise      # load Revise before Kaimon
#

using Pkg

const PROJECT_DIR = joinpath(@__DIR__, "..")
Pkg.activate(PROJECT_DIR)

# Parse args early so --revise can be honored before loading Kaimon.
function parse_args()
    port = 2828
    theme = :kokaku
    use_revise = false

    i = 1
    while i <= length(ARGS)
        if ARGS[i] in ("--port", "-p") && i + 1 <= length(ARGS)
            port = parse(Int, ARGS[i+1])
            i += 2
        elseif ARGS[i] in ("--theme", "-t") && i + 1 <= length(ARGS)
            theme = Symbol(ARGS[i+1])
            i += 2
        elseif ARGS[i] in ("--revise", "-r")
            use_revise = true
            i += 1
        elseif ARGS[i] in ("--help", "-h")
            println("""
            Kaimon TUI — persistent MCP server with terminal dashboard

            Usage: kaimon [options]

            Options:
              -p, --port PORT    MCP HTTP server port (default: 2828)
              -t, --theme NAME   Theme: kokaku, esper, motoko, neuromancer (default: kokaku)
              -r, --revise       Load Revise before Kaimon
              -h, --help         Show this help

            Start a Gate session in your Julia REPL:
              using Kaimon
              Gate.serve(name="myproject")
            """)
            exit(0)
        else
            println("Unknown argument: $(ARGS[i])")
            exit(1)
        end
    end
    return (; port, theme, use_revise)
end

(; port, theme, use_revise) = parse_args()

# Auto-instantiate if Manifest is missing or stale
let manifest = joinpath(PROJECT_DIR, "Manifest.toml")
    project = joinpath(PROJECT_DIR, "Project.toml")
    if !isfile(manifest)
        @info "First run — installing dependencies (Pkg.instantiate)..."
        Pkg.instantiate()
    elseif mtime(project) > mtime(manifest)
        @info "Project.toml changed — resolving dependencies..."
        Pkg.resolve()
    end
end

# Precompile if needed (Pkg.precompile is a no-op when up to date)
Pkg.precompile()

if use_revise
    try
        @eval using Revise
    catch e
        @warn "Could not load Revise, continuing without it" exception = e
    end
end

# Load optional extensions before Kaimon so they activate on package load.
try @eval using PDFIO catch end

using Kaimon

if use_revise && isdefined(Main, :Revise)
    # Revise is loaded and tracking Kaimon. In a REPL, revisions apply
    # automatically via AST transforms. In a script (no REPL backend),
    # we need a background task to call Revise.revise() periodically.
    # Poll-based Revise: check for changes every 3 seconds.
    # Event-based (Revise.revision_event) doesn't reliably fire in non-REPL
    # scripts since there's no entr() or REPL backend polling inotify.
    Threads.@spawn begin
        while true
            try
                Main.Revise.revise()
            catch e
                e isa InterruptException && break
            end
            sleep(3)
        end
    end
end

# Check that Kaimon is in the global Julia environment.
# Gate.serve() is called from users' own project REPLs, so Kaimon must be
# accessible outside this cloned repo — the global env is the right place.
if isa(stdin, Base.TTY)
    let global_env = joinpath(homedir(), ".julia", "environments",
                               "v$(VERSION.major).$(VERSION.minor)")
        global_proj = joinpath(global_env, "Project.toml")
        in_global = isfile(global_proj) &&
            haskey(get(Pkg.TOML.parsefile(global_proj), "deps", Dict()), "Kaimon")

        if !in_global
            println("""

            Kaimon is not installed in your global Julia environment.

            Gate.serve() must be called from your project REPLs to connect them
            to the Kaimon dashboard. For this to work, Kaimon needs to be
            available in every Julia session — the global environment is the
            recommended place to install it.
            """)
            print("Add Kaimon to your global Julia environment now? [Y/n]: ")
            response = strip(readline())
            if isempty(response) || lowercase(response) in ("y", "yes")
                @info "Installing Kaimon in global environment..."
                try
                    Pkg.activate()
                    Pkg.develop(PackageSpec(path = PROJECT_DIR))
                    Pkg.activate(PROJECT_DIR)
                    println("\nDone. You can now call `using Kaimon` from any Julia session.\n")
                catch e
                    @warn "Global install failed" exception = e
                    Pkg.activate(PROJECT_DIR)
                end
            else
                println()
            end
        end
    end
end

# First-time setup: launch security wizard if no config exists
has_config = Kaimon.load_security_config() !== nothing ||
             Kaimon.load_global_security_config() !== nothing

if !has_config
    result = Kaimon.setup_wizard_tui()
    if result === nothing
        exit(0)
    end
end

tui(; port, theme_name=theme)
