import{_ as c,C as h,o as i,c as p,j as t,a as o,b as r,w as a,E as l,a4 as n,a3 as d}from"./chunks/framework.CL3B3Tmm.js";const S=JSON.parse('{"title":"Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"architecture.md","filePath":"architecture.md","lastUpdated":null}'),g={name:"architecture.md"};function u(m,e,y,k,P,b){const s=h("Mermaid");return i(),p("div",null,[e[2]||(e[2]=t("h1",{id:"architecture",tabindex:"-1"},[o("Architecture "),t("a",{class:"header-anchor",href:"#architecture","aria-label":'Permalink to "Architecture"'},"​")],-1)),e[3]||(e[3]=t("p",null,"Kaimon exposes Julia REPLs as MCP (Model Context Protocol) servers for AI agents. This document describes the system architecture, communication protocols, and key modules.",-1)),e[4]||(e[4]=t("h2",{id:"System-Overview",tabindex:"-1"},[o("System Overview "),t("a",{class:"header-anchor",href:"#System-Overview","aria-label":'Permalink to "System Overview {#System-Overview}"'},"​")],-1)),(i(),r(n,null,{default:a(()=>[l(s,{id:"mermaid-9",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20subgraph%20clients%5B%22MCP%20Clients%22%5D%0A%20%20%20%20%20%20%20%20cc%5B%22Claude%20Code%20%C2%B7%20Cursor%20%C2%B7%20VS%20Code%22%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20server%5B%22Kaimon%20Server%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20http%5B%22HTTP%20Endpoint%3Cbr%2F%3Eport%202828%22%5D%0A%20%20%20%20%20%20%20%20router%5B%22Tool%20Router%3Cbr%2F%3ESession%20Manager%22%5D%0A%20%20%20%20%20%20%20%20gc%5B%22Gate%20Client%3Cbr%2F%3EConnectionManager%22%5D%0A%20%20%20%20%20%20%20%20http%20--%3E%20router%20--%3E%20gc%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20repls%5B%22Julia%20REPLs%22%5D%0A%20%20%20%20%20%20%20%20r1%5B%22Gate%20%C2%B7%20REPL%20%231%22%5D%0A%20%20%20%20%20%20%20%20r2%5B%22Gate%20%C2%B7%20REPL%20%232%22%5D%0A%20%20%20%20end%0A%0A%20%20%20%20clients%20%3C--%3E%7C%22JSON-RPC%20%2F%20HTTP%22%7C%20http%0A%20%20%20%20gc%20%3C--%3E%7C%22ZMQ%20IPC%22%7C%20r1%0A%20%20%20%20gc%20%3C--%3E%7C%22ZMQ%20IPC%22%7C%20r2%0A"})]),fallback:a(()=>[...e[0]||(e[0]=[o(" Loading... ",-1)])]),_:1})),e[5]||(e[5]=d('<p>MCP clients communicate with the Kaimon server over HTTP. The server routes tool calls either to its own process (standalone mode) or through ZMQ IPC sockets to external Julia REPLs (TUI/gate mode).</p><h2 id="MCP-Protocol-Layer" tabindex="-1">MCP Protocol Layer <a class="header-anchor" href="#MCP-Protocol-Layer" aria-label="Permalink to &quot;MCP Protocol Layer {#MCP-Protocol-Layer}&quot;">​</a></h2><p>Kaimon implements the <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/transports#streamable-http" target="_blank" rel="noreferrer">MCP Streamable HTTP transport</a>. All communication uses JSON-RPC 2.0 over HTTP POST.</p><h3 id="endpoints" tabindex="-1">Endpoints <a class="header-anchor" href="#endpoints" aria-label="Permalink to &quot;Endpoints&quot;">​</a></h3><table tabindex="0"><thead><tr><th style="text-align:right;">Path</th><th style="text-align:right;">Method</th><th style="text-align:right;">Description</th></tr></thead><tbody><tr><td style="text-align:right;"><code>/</code> or <code>/mcp</code></td><td style="text-align:right;">POST</td><td style="text-align:right;">JSON-RPC requests (tool calls, initialize, etc.)</td></tr><tr><td style="text-align:right;"><code>/vscode-response</code></td><td style="text-align:right;">POST</td><td style="text-align:right;">Bidirectional VS Code command responses</td></tr><tr><td style="text-align:right;"><code>/.well-known/agents.md</code></td><td style="text-align:right;">GET</td><td style="text-align:right;">Project AGENTS.md file</td></tr></tbody></table><h3 id="Request-Lifecycle" tabindex="-1">Request Lifecycle <a class="header-anchor" href="#Request-Lifecycle" aria-label="Permalink to &quot;Request Lifecycle {#Request-Lifecycle}&quot;">​</a></h3><ol><li><p>Client sends a JSON-RPC POST with <code>Mcp-Session-Id</code> header.</p></li><li><p>Server resolves or creates an <code>MCPSession</code> from the header.</p></li><li><p>For <code>tools/call</code> requests, the server looks up the tool by name and dispatches to its handler.</p></li><li><p>In gate mode, long-running tool calls (like <code>ex</code>) use SSE streaming: the response is <code>Content-Type: text/event-stream</code> with <code>notifications/progress</code> events followed by the final JSON-RPC result.</p></li><li><p>Non-streaming responses return <code>Content-Type: application/json</code>.</p></li></ol><h3 id="Session-Management" tabindex="-1">Session Management <a class="header-anchor" href="#Session-Management" aria-label="Permalink to &quot;Session Management {#Session-Management}&quot;">​</a></h3><p>Each MCP client connection is tracked as an <code>MCPSession</code> with states:</p><ul><li><p><strong>UNINITIALIZED</strong> – Session created, awaiting <code>initialize</code> request.</p></li><li><p><strong>INITIALIZED</strong> – Protocol version negotiated, ready for tool calls.</p></li><li><p><strong>CLOSED</strong> – Session terminated.</p></li></ul><p>Sessions are persisted to <code>~/.cache/kaimon/sessions.json</code> so clients can reconnect after a server restart without re-initializing.</p><h2 id="Kaimon-Server" tabindex="-1">Kaimon Server <a class="header-anchor" href="#Kaimon-Server" aria-label="Permalink to &quot;Kaimon Server {#Kaimon-Server}&quot;">​</a></h2><p>The server (<code>src/MCPServer.jl</code>) is an HTTP.jl server that handles:</p><ul><li><p><strong>Tool routing</strong> – Maintains a <code>Dict{Symbol, MCPTool}</code> registry mapping tool IDs to handlers. Tools are defined with the <code>@mcp_tool</code> macro or assembled by <code>collect_tools()</code>.</p></li><li><p><strong>Session management</strong> – Per-request session lookup via the <code>Mcp-Session-Id</code> header, with automatic creation for clients that skip initialization.</p></li><li><p><strong>Security enforcement</strong> – Every request passes through API key and IP validation before reaching the handler.</p></li><li><p><strong>SSE streaming</strong> – For gate-mode tool calls that may run for seconds or minutes, the server streams progress notifications as SSE events with a 5-second heartbeat to prevent connection timeouts.</p></li><li><p><strong>Dynamic tool registration</strong> – Tools can be registered and unregistered at runtime (e.g., when a gate session connects with custom tools). The server sends <code>notifications/tools/list_changed</code> so clients refresh their tool list.</p></li></ul><h3 id="Standalone-vs.-TUI-Mode" tabindex="-1">Standalone vs. TUI Mode <a class="header-anchor" href="#Standalone-vs.-TUI-Mode" aria-label="Permalink to &quot;Standalone vs. TUI Mode {#Standalone-vs.-TUI-Mode}&quot;">​</a></h3><table tabindex="0"><thead><tr><th style="text-align:right;"></th><th style="text-align:right;">Standalone (<code>start!()</code>)</th><th style="text-align:right;">TUI (<code>tui()</code>)</th></tr></thead><tbody><tr><td style="text-align:right;">Process model</td><td style="text-align:right;">Server + REPL in one process</td><td style="text-align:right;">Server in TUI process, REPLs connect via Gate</td></tr><tr><td style="text-align:right;">Code execution</td><td style="text-align:right;">Direct <code>Core.eval(Main, expr)</code></td><td style="text-align:right;">Forwarded over ZMQ to external REPL</td></tr><tr><td style="text-align:right;">Default port</td><td style="text-align:right;">From config (dynamic)</td><td style="text-align:right;">2828</td></tr><tr><td style="text-align:right;">Dashboard</td><td style="text-align:right;">None (REPL prompt indicator)</td><td style="text-align:right;">Full terminal UI</td></tr><tr><td style="text-align:right;">Multi-session</td><td style="text-align:right;">Single REPL</td><td style="text-align:right;">Multiple REPLs via Gate</td></tr></tbody></table><h2 id="The-Gate-Module" tabindex="-1">The Gate Module <a class="header-anchor" href="#The-Gate-Module" aria-label="Permalink to &quot;The Gate Module {#The-Gate-Module}&quot;">​</a></h2><p>The Gate (<code>src/gate.jl</code>) is the bridge between the Kaimon server and external Julia processes.</p><h3 id="Gate-Server-REPL-side" tabindex="-1">Gate Server (REPL side) <a class="header-anchor" href="#Gate-Server-REPL-side" aria-label="Permalink to &quot;Gate Server (REPL side) {#Gate-Server-REPL-side}&quot;">​</a></h3><p><code>Gate.serve()</code> runs inside the user&#39;s Julia REPL. It:</p><ol><li><p>Binds a ZMQ REP socket at <code>~/.cache/kaimon/sock/&lt;session-id&gt;.sock</code>.</p></li><li><p>Opens a ZMQ PUB socket for streaming stdout/stderr during eval.</p></li><li><p>Enters a message loop that handles requests:</p></li></ol><ul><li><p><code>:eval</code> / <code>:eval_async</code> – Evaluate Julia code, capturing stdout, stderr, return value, and exceptions.</p></li><li><p><code>:ping</code> – Health check returning session metadata, Revise status, project path, Julia version, PID, and registered tool metadata.</p></li><li><p><code>:restart</code> – Restart the Julia process via <code>execvp</code>, preserving the session ID so the TUI reconnects automatically.</p></li><li><p><code>:tool_call</code> – Dispatch to a session-scoped <code>GateTool</code> handler.</p></li></ul><h3 id="Gate-Client-TUI-side" tabindex="-1">Gate Client (TUI side) <a class="header-anchor" href="#Gate-Client-TUI-side" aria-label="Permalink to &quot;Gate Client (TUI side) {#Gate-Client-TUI-side}&quot;">​</a></h3><p>The <code>ConnectionManager</code> (<code>src/gate_client.jl</code>) runs inside the Kaimon TUI process. It:</p><ol><li><p>Watches <code>~/.cache/kaimon/sock/</code> for new <code>.sock</code> files.</p></li><li><p>Connects a ZMQ REQ socket to each discovered gate.</p></li><li><p>Maintains <code>REPLConnection</code> objects with health status, project metadata, and tool call counts.</p></li><li><p>Provides <code>eval_remote()</code> and <code>eval_remote_async()</code> for sending code to specific sessions.</p></li></ol><h3 id="Session-Scoped-Tools-GateTool" tabindex="-1">Session-Scoped Tools (GateTool) <a class="header-anchor" href="#Session-Scoped-Tools-GateTool" aria-label="Permalink to &quot;Session-Scoped Tools (GateTool) {#Session-Scoped-Tools-GateTool}&quot;">​</a></h3><p>Gate sessions can register custom tools:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Gate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tools</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Gate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GateTool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;my_tool&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, my_handler)])</span></span></code></pre></div><p>The Gate reflects on the handler function&#39;s type signature using Julia&#39;s reflection APIs (<code>methods</code>, <code>fieldnames</code>, <code>fieldtypes</code>) to generate MCP JSON Schema automatically. This includes support for:</p><ul><li><p>Primitive types (String, Int, Float64, Bool)</p></li><li><p>Enums (mapped to JSON Schema <code>enum</code>)</p></li><li><p>Structs (mapped to JSON Schema <code>object</code> with typed fields)</p></li><li><p><code>Union{T, Nothing}</code> (marks the parameter as optional)</p></li><li><p>Vectors (mapped to JSON Schema <code>array</code> with element type)</p></li></ul><p>When a gate session connects, the TUI registers its tools into the MCP server&#39;s tool registry and sends <code>notifications/tools/list_changed</code>.</p><h2 id="TUI-Architecture" tabindex="-1">TUI Architecture <a class="header-anchor" href="#TUI-Architecture" aria-label="Permalink to &quot;TUI Architecture {#TUI-Architecture}&quot;">​</a></h2><p>The terminal dashboard (<code>src/tui.jl</code> and <code>src/tui/</code>) is built on <a href="https://github.com/kburke/Tachikoma.jl" target="_blank" rel="noreferrer">Tachikoma.jl</a>, a Julia TUI framework. It follows the Elm architecture:</p>',33)),(i(),r(n,null,{default:a(()=>[l(s,{id:"mermaid-361",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20ev(%5B%22%E2%8C%A8%20Events%3Cbr%2F%3Ekey%20%C2%B7%20mouse%20%C2%B7%20tick%22%5D)%20--%3E%20up%5B%22update!%22%5D%0A%20%20%20%20up%20--%3E%7C%22new%20state%22%7C%20m%5B%22Model%3Cbr%2F%3EKaimonModel%22%5D%0A%20%20%20%20m%20--%3E%20v%5B%22view%22%5D%0A%20%20%20%20v%20--%3E%20fr(%5B%22%E2%AC%9B%20Terminal%20Frame%22%5D)%0A%20%20%20%20up%20-.-%3E%7C%22async%22%7C%20ef(%5B%22%E2%9A%99%20Side%20Effects%22%5D)%0A"})]),fallback:a(()=>[...e[1]||(e[1]=[o(" Loading... ",-1)])]),_:1})),e[6]||(e[6]=d('<ul><li><p><strong>Model</strong> (<code>KaimonModel</code> in <code>src/tui/types.jl</code>) – All application state: connection manager, server status, activity log, in-flight tool calls, search index state, configuration flow state.</p></li><li><p><strong>update!</strong> (<code>src/tui/update.jl</code>) – Handles keyboard events, tick events (polling gate health, processing reindex queues), and background task results.</p></li><li><p><strong>view</strong> (<code>src/tui/view.jl</code>) – Renders the model into Tachikoma widgets (Block, TabBar, Table, SelectableList, StatusBar, Modal, etc.) that produce a terminal frame at 30 fps.</p></li></ul><p>The TUI has several tabs:</p><ul><li><p><strong>Sessions</strong> – Connected REPL gates with status and metadata.</p></li><li><p><strong>Activity</strong> – Live tool call feed with in-flight progress tracking.</p></li><li><p><strong>Server</strong> – MCP server logs and configuration.</p></li><li><p><strong>Search</strong> – Qdrant vector search index management.</p></li><li><p><strong>Config</strong> – Security and client configuration.</p></li><li><p><strong>Advanced</strong> – Debug and diagnostics.</p></li></ul><h3 id="Hot-Reload" tabindex="-1">Hot Reload <a class="header-anchor" href="#Hot-Reload" aria-label="Permalink to &quot;Hot Reload {#Hot-Reload}&quot;">​</a></h3><p>The TUI supports Revise.jl hot reloading via <code>Ctrl-U</code>. The app loop exits, calls <code>Revise.revise()</code>, and re-enters <code>app()</code> with <code>Base.invokelatest</code> so updated <code>view()</code> and <code>update!()</code> methods take effect without restarting.</p><h2 id="Security-Layer" tabindex="-1">Security Layer <a class="header-anchor" href="#Security-Layer" aria-label="Permalink to &quot;Security Layer {#Security-Layer}&quot;">​</a></h2><p>Security is configured in <code>~/.config/kaimon/security.json</code> (global) or <code>.kaimon/security.json</code> (per-project). The configuration defines:</p><h3 id="Three-Security-Modes" tabindex="-1">Three Security Modes <a class="header-anchor" href="#Three-Security-Modes" aria-label="Permalink to &quot;Three Security Modes {#Three-Security-Modes}&quot;">​</a></h3><table tabindex="0"><thead><tr><th style="text-align:right;">Mode</th><th style="text-align:right;">API Key Required</th><th style="text-align:right;">IP Allowlist Enforced</th><th style="text-align:right;">Use Case</th></tr></thead><tbody><tr><td style="text-align:right;"><code>strict</code></td><td style="text-align:right;">Yes</td><td style="text-align:right;">Yes</td><td style="text-align:right;">Production, shared machines</td></tr><tr><td style="text-align:right;"><code>relaxed</code></td><td style="text-align:right;">Yes</td><td style="text-align:right;">No</td><td style="text-align:right;">Local development with auth</td></tr><tr><td style="text-align:right;"><code>lax</code></td><td style="text-align:right;">No</td><td style="text-align:right;">No</td><td style="text-align:right;">Trusted local-only setups</td></tr></tbody></table><h3 id="Authentication-Flow" tabindex="-1">Authentication Flow <a class="header-anchor" href="#Authentication-Flow" aria-label="Permalink to &quot;Authentication Flow {#Authentication-Flow}&quot;">​</a></h3><ol><li><p>Extract <code>Authorization: Bearer &lt;key&gt;</code> from the request header.</p></li><li><p>Validate the key against the configured <code>api_keys</code> list.</p></li><li><p>In <code>strict</code> mode, also validate the client IP against <code>allowed_ips</code> (defaults to <code>127.0.0.1</code> and <code>::1</code>).</p></li><li><p>For VS Code bidirectional communication, single-use cryptographic nonces replace API keys to prevent replay attacks.</p></li></ol><h3 id="API-Key-Format" tabindex="-1">API Key Format <a class="header-anchor" href="#API-Key-Format" aria-label="Permalink to &quot;API Key Format {#API-Key-Format}&quot;">​</a></h3><p>Keys follow the pattern <code>kaimon_&lt;40 hex chars&gt;</code> (160-bit entropy). They are generated by <code>Kaimon.generate_key()</code> or during the setup wizard.</p><h2 id="Key-File-Locations" tabindex="-1">Key File Locations <a class="header-anchor" href="#Key-File-Locations" aria-label="Permalink to &quot;Key File Locations {#Key-File-Locations}&quot;">​</a></h2><table tabindex="0"><thead><tr><th style="text-align:right;">Path</th><th style="text-align:right;">Purpose</th></tr></thead><tbody><tr><td style="text-align:right;"><code>~/.config/kaimon/security.json</code></td><td style="text-align:right;">Global security configuration</td></tr><tr><td style="text-align:right;"><code>.kaimon/security.json</code></td><td style="text-align:right;">Per-project security override</td></tr><tr><td style="text-align:right;"><code>.kaimon/tools.json</code></td><td style="text-align:right;">Per-project tool enable/disable config</td></tr><tr><td style="text-align:right;"><code>~/.cache/kaimon/sock/</code></td><td style="text-align:right;">ZMQ IPC socket files for gate connections</td></tr><tr><td style="text-align:right;"><code>~/.cache/kaimon/sessions.json</code></td><td style="text-align:right;">Persisted MCP session state</td></tr><tr><td style="text-align:right;"><code>~/.cache/kaimon/</code></td><td style="text-align:right;">Logs, database, and other operational files</td></tr></tbody></table>',15))])}const T=c(g,[["render",u]]);export{S as __pageData,T as default};
